@page "/map"

@using ResearchRecruitment.ViewModels
@using ResearchRecruitment.Models

@inject IJSRuntime JS
@inject MapPageViewModel viewModel
@inject ISnackbar snackbar
@implements IDisposable

<style>
    canvas
    {
        width: 100% !important;
        height: 100% !important;
    }
</style>

@if (viewModel.IsLoading)
{
    <SkeletonLoading />
}
else
{
    <MudLayout>
        <Navbar />
        <Appbar />

        <MudMainContent Style="background: #f5f7fa;">
            <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mb-6">

                <MudStack Spacing="2" Class="mb-6">
                    <MudText Typo="Typo.h4" Style="font-weight: 700;">
                        Use filters or the map to locate suitable participants for your study.
                    </MudText>
                </MudStack>

                <MudPaper Elevation="2" Class="pa-4 mb-4" Style="border-radius: 16px;">
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600;">Search by:</MudText>
                    <MudGrid Spacing="3">
                            <MudCheckBox Value="viewModel.GroupByBools[0]"
                                         ValueChanged="@(async (bool val) =>
                                             {
                                                 viewModel.GroupByBools[0] = val;
                                                 await UpdateMapAsync();
                                             })"
                                     ValueExpression="() => viewModel.GroupByBools[0]">
                                Group By Firstname
                            </MudCheckBox>

                            <MudCheckBox Value="viewModel.GroupByBools[1]"
                                         ValueChanged="@(async (bool val) =>
                                             {
                                                 viewModel.GroupByBools[1] = val;
                                                 await UpdateMapAsync();
                                             })"
                                     ValueExpression="() => viewModel.GroupByBools[1]">
                                Group By Surname
                            </MudCheckBox>

                            <MudCheckBox Value="viewModel.GroupByBools[2]"
                                         ValueChanged="@(async (bool val) =>
                                             {
                                                 viewModel.GroupByBools[2] = val;
                                                 await UpdateMapAsync();
                                             })"
                                     ValueExpression="() => viewModel.GroupByBools[2]">
                                Group By Age
                            </MudCheckBox>

                            <MudCheckBox Value="viewModel.GroupByBools[3]"
                                         ValueChanged="@(async (bool val) =>
                                             {
                                                 viewModel.GroupByBools[3] = val;
                                                 await UpdateMapAsync();
                                             })"
                                     ValueExpression="() => viewModel.GroupByBools[3]">
                                Group By Interests
                            </MudCheckBox>

                            <MudCheckBox Value="viewModel.GroupByBools[4]"
                                         ValueChanged="@(async (bool val) =>
                                             {
                                                 viewModel.GroupByBools[4] = val;
                                                 await UpdateMapAsync();
                                             })"
                                     ValueExpression="() => viewModel.GroupByBools[4]">
                                Group By Nationality
                            </MudCheckBox>

                            <MudCheckBox Value="viewModel.GroupByBools[5]"
                                         ValueChanged="@(async (bool val) =>
                                             {
                                                 viewModel.GroupByBools[5] = val;
                                                 await UpdateMapAsync();
                                             })"
                                     ValueExpression="() => viewModel.GroupByBools[5]">
                                Group By Gender
                            </MudCheckBox>
                    </MudGrid>
                </MudPaper>

                <MudGrid Spacing="4">

                    <MudItem xs="12" lg="7">
                        <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 16px; min-height: 600px;">
                            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600;">Interactive Map</MudText>
                            <div id="p5-container" style="width: 100%; height: 550px;"></div>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" lg="5">
                        <MudPaper Elevation="2" Class="pa-6" Style="border-radius: 16px; height: 100%;">
                            <MudStack Spacing="4">

                                <MudText Typo="Typo.h6" Style="font-weight: 600;">Participant Details</MudText>

                                <MudDivider />

                                @if (selectedParticipant != null)
                                {
                                    <MudStack Spacing="3">
                                        <MudTextField Label="Firstname" Variant="Variant.Outlined" ReadOnly="true" @bind-Value="selectedParticipant.Firstname" />
                                        <MudTextField Label="Lastname" Variant="Variant.Outlined" ReadOnly="true" @bind-Value="selectedParticipant.Lastname" />
                                        <MudTextField Label="Age" Variant="Variant.Outlined" ReadOnly="true" @bind-Value="selectedParticipant.Age" />
                                        <MudTextField Label="Gender" Variant="Variant.Outlined" ReadOnly="true" @bind-Value="selectedParticipant.Gender" />
                                        <MudTextField Label="Nationality" Variant="Variant.Outlined" ReadOnly="true" @bind-Value="selectedParticipant.Nationality" />
                                        <MudTextField Label="Interests" Variant="Variant.Outlined" ReadOnly="true" @bind-Value="selectedParticipant.Interests" />
                                    </MudStack>

                                    <MudStack Row="true" Spacing="2">
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Email" FullWidth="true" Style="border-radius: 12px; font-weight: 600; background: #0F0867; color: white;">
                                            Invite
                                        </MudButton>

                                        <MudButton Class="primary-button" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ContactMail" FullWidth="true" Style="border-radius: 12px; font-weight: 600; border-color: #0F0867; background: white; color: black;">
                                            Contact
                                        </MudButton>
                                    </MudStack>
                                }
                                else
                                {
                                    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 100%;">
                                        <MudIcon Icon="@Icons.Material.Filled.PersonSearch" Size="Size.Large" Style="font-size: 4rem; color: #ccc;" />
                                        <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center">
                                            Select a participant on the map to view details
                                        </MudText>
                                    </MudStack>
                                }

                            </MudStack>
                        </MudPaper>
                    </MudItem>

                </MudGrid>

                <MudButton Variant="Variant.Text"
                           Color="Color.Default"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           Href="/post-study"
                           Class="mt-6"
                           Style="font-weight: 600;">
                    Back to Post a Study
                </MudButton>

            </MudContainer>
        </MudMainContent>
    </MudLayout>
}

@code
{
    private string dataJson = string.Empty;
    private bool mapRenderComplete = false;

    private DotNetObjectReference<MapPage>? objRef;

    bool drawerOpen = true;

    string selectedStudy = "";
    string location = "";
    string selectedAgeGroup = "";
    string interest = "";

    ParticipantDetails? selectedParticipant = null;

    void ToggleDrawer()
    {
        drawerOpen = !drawerOpen;
    }

    public void OnParticipantSelected(ParticipantDetails participant)
    {
        selectedParticipant = participant;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) { return; }

        viewModel.IsLoading = true;
        //await InvokeAsync(StateHasChanged);
        dataJson = await viewModel.LoadEmbeddingDataAsync();

        try
        {
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("renderingCode.start", dataJson, objRef);
        }
        catch
        {
            snackbar.Add("Error Loading Data. Please Contact Support if Issue Persists", Severity.Error);
        }
        finally
        {
            viewModel.IsLoading = false;
            //await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnParticipantSelected(string participantID)
    {
        ParticipantDetails? responseModel = await viewModel.LoadParticipantDataAsync(participantID);

        if (responseModel == null)
        {
            snackbar.Add("Error Loading Participant Data. Please Contact Support if Issue Persists", Severity.Error);
            return;
        }

        selectedParticipant = responseModel;
        StateHasChanged();
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }

    private async Task UpdateMapAsync()
    {
        dataJson = await viewModel.LoadEmbeddingDataAsync();
        await JS.InvokeVoidAsync("renderingCode.start", dataJson, objRef);
    }
}